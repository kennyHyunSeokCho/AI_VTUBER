<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏïÑÎ∞îÌÉÄ ÏÉùÏÑ±</title>
    <style>
        @font-face { font-family: 'KoreanSerif', serif; }
        @font-face { font-family: 'Javanese Text'; }
        :root {
            --menu-box-width: 200px;
            --menu-spacer-gap: 15px;
            --menu-font-height: 26px;
            --width-my: 35px; --width-voice: 75px; --width-avatar: 75px; --width-live: 50px; --width-voicechanger: 150px;
            --menu-offset: 45.5px;
            --bottom-divider-width: 150px;
            --circle-size: 72px;
            --toggle-icon-width: 48px; --toggle-icon-height: 28px;
        }
        body, html { margin: 0; padding: 0; overflow: hidden; height: 100%; }
        body { background: #261D23; font-family: 'KoreanSerif', 'NanumMyeongjo', serif; color: white; display: flex; justify-content: center; align-items: center; }
        .app-frame { width: 100vw; height: 100vh; position: relative; display: flex; flex-direction: column; padding-top: 80px; }
        .menu-toggle-icon-wrapper { position: fixed; right: 40px; top: 40px; width: var(--toggle-icon-width); height: var(--toggle-icon-height); z-index: 700; transition: all 0.4s ease-in-out; cursor: pointer; }
        .menu-toggle-icon { width: 100%; height: 100%; display: block; }
        .menu-toggle-icon:hover { transform: scale(1.1); }
        .chat-history { width: 90%; max-width: 688px; flex-grow: 1; margin: 40px auto 30px; padding: 0 20px; overflow-y: auto; background: transparent; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 14px; word-break: break-word; line-height: 1.7; }
        .chat-message.user { background: #FF019B; color: #1B1B1B; align-self: flex-end; border-bottom-right-radius: 5px; }
        .chat-message.system { background: #1B1B1B; color: white; align-self: flex-start; border-bottom-left-radius: 5px; }
        .input-controls-area { width: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 30px 0 60px; z-index: 100; flex-shrink: 0; }
        .input-box-background { width: 90%; max-width: 688px; height: 200px; min-height: 120px; background: #1B1B1B; box-shadow: 0px 0px 30px rgba(255, 1, 155, 0.40); border-radius: 20px; outline: 1px #FF019B solid; position: relative; }
        .input-field { position: absolute; top: 0; left: 0; width: calc(100% - 40px); height: calc(100% - 40px); background: transparent; border: none; resize: none; padding: 20px; color: white; font-size: 14px; font-family: 'KoreanSerif', 'NanumMyeongjo', serif; font-weight: 600; line-height: 1.7; outline: none; }
        .input-field::placeholder { color: #888; font-weight: 400; }
        .button-container { display: flex; gap: 15px; margin-top: 20px; justify-content: center; align-items: center; }
        .save-button-link { width: 163px; height: 58px; background: #FF019B; border-radius: 100px; text-decoration: none; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s ease; box-shadow: none; z-index: 1000; }
        .save-button-link:hover { transform: scale(1.05); box-shadow: 0px 4px 15px rgba(255, 1, 155, 0.5); }
        .download-button-link { width: 163px; height: 58px; background: #1B1B1B; border: 2px solid #FF019B; border-radius: 100px; text-decoration: none; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s ease; z-index: 1000; }
        .download-button-link:hover { transform: scale(1.05); background: #2B2B2B; }
        .save-button-text { color: black; font-size: 28px; font-weight: 600; }
        .download-button-text { color: #FF019B; font-size: 24px; font-weight: 600; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
        .loading-popup-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 589px; height: 150px; background: #FF019B; border-radius: 100px; z-index: 1001; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; }
        .loading-text { color: black; font-size: 28px; font-weight: 600; }
        .sidebar-container { position: fixed; top: 0; right: 0; width: 291px; height: 100%; z-index: 500; overflow: hidden; transition: transform 0.4s ease-in-out; transform: translateX(291px); }
        .sidebar-container.sidebar-open { transform: translateX(0); }
        .sidebar-header { width: 100%; height: 100px; background: black; position: relative; }
        .sidebar-main { width: 100%; height: calc(100% - 100px); background: #FF019B; position: relative; padding-top: 50px; }
        .menu-link { color: black; font-family: 'Javanese Text'; font-size: 22px; font-weight: 400; text-decoration: none; display: block; position: absolute; cursor: pointer; height: var(--menu-font-height); white-space: nowrap; }
        .divider { height: 1px; outline: 1px black solid; outline-offset: -0.50px; position: absolute; }
        .menu-my { left: var(--menu-offset); top: 53px; }
        .divider-1 { width: calc(var(--menu-box-width) - var(--width-my) - var(--menu-spacer-gap)); right: var(--menu-offset); top: 65.5px; }
        .menu-avatar { right: var(--menu-offset); top: 143px; text-align: right; }
        .divider-3 { width: calc(var(--menu-box-width) - var(--width-avatar) - var(--menu-spacer-gap)); left: var(--menu-offset); top: 155.5px; }
        .menu-voice { left: var(--menu-offset); top: 233px; }
        .divider-2 { width: calc(var(--menu-box-width) - var(--width-voice) - var(--menu-spacer-gap)); right: var(--menu-offset); top: 245.5px; }
        .menu-live { right: var(--menu-offset); top: 278px; text-align: right; }
        .divider-5 { width: calc(var(--menu-box-width) - var(--width-live) - var(--menu-spacer-gap)); left: var(--menu-offset); top: 290.5px; }
        .menu-voicechanger { right: var(--menu-offset); top: 323px; text-align: right; font-size: 20px; }
        .divider-4 { width: calc(var(--menu-box-width) - var(--width-voicechanger) - var(--menu-spacer-gap)); left: var(--menu-offset); top: 335.5px; }
        .menu-circle { width: var(--circle-size); height: var(--circle-size); border-radius: 9999px; border: 1px black solid; position: absolute; top: 120px; right: calc(var(--menu-offset) - (var(--circle-size) - var(--width-avatar)) / 2); }
        .image-bottom { width: var(--menu-box-width); height: 230px; position: absolute; left: var(--menu-offset); top: 410px; }
        .slogan-1 { width: 100%; position: absolute; top: 670px; text-align: center; color: black; font-size: 13px; font-family: 'Javanese Text'; font-weight: 400; letter-spacing: 0.2em; }
        .slogan-2 { width: 100%; position: absolute; top: 705px; text-align: center; color: black; font-size: 10px; font-family: 'Javanese Text'; font-weight: 400; letter-spacing: 0.2em; }
        .divider-bottom { width: var(--bottom-divider-width); left: calc(50% - (var(--bottom-divider-width) / 2)); top: 800px; }
    </style>
</head>
<body>

    <div id="menuToggleWrapper" class="menu-toggle-icon-wrapper" onclick="toggleSidebar()" title="Î©îÎâ¥ ÌÜ†Í∏Ä">
        <div id="menuToggle" class="menu-toggle-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="35" viewBox="0 0 48 35" fill="none">
                <path d="M0 31.5H48M0 17.5H48M0 3.5H48" stroke="#FF019B" stroke-width="7"/>
            </svg>
        </div>
    </div>

    <div id="appFrame" class="app-frame">
        <div id="chatHistory" class="chat-history"></div>
        <div class="input-controls-area">
            <div class="input-box-background">
                <textarea id="inputField" class="input-field" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."></textarea>
            </div>
            <div class="button-container">
                <a class="save-button-link" onclick="sendMessage()" title="Î©îÏãúÏßÄ Ï†ÑÏÜ°">
                    <div class="save-button-text">Ï†Ñ ÏÜ°</div>
                </a>
                <a class="download-button-link" onclick="downloadImage()" title="Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú">
                    <div class="download-button-text">Îã§Ïö¥Î°úÎìú</div>
                </a>
            </div>
        </div>
    </div>

    <div id="sidebarContainer" class="sidebar-container">
        <div id="sidebarHeader" class="sidebar-header"></div>
        <div id="sidebarMain" class="sidebar-main">
            <a id="menuMy" class="menu-link menu-my" href="index.html">My</a>
            <div id="divider1" class="divider divider-1"></div>
            <div id="divider3" class="divider divider-3"></div>
            <div id="menuAvatar" class="menu-link menu-avatar">Avatar</div>
            <a id="menuVoice" class="menu-link menu-voice" href="voice.html">Voice</a>
            <div id="divider2" class="divider divider-2"></div>
            <a id="menuLive" class="menu-link menu-live" href="#">Live</a>
            <div id="divider5" class="divider divider-5"></div>
            <a id="menuVoiceChanger" class="menu-link menu-voicechanger" href="#">VoiceChanger</a>
            <div id="divider4" class="divider divider-4"></div>
            <div id="menuCircle" class="menu-circle"></div>
            <div id="imageBottom" class="image-bottom">
                <img src="assets/image6.png" alt="Sidebar Bottom Image" onerror="this.onerror=null; this.src='https://placehold.co/200x230/FF019B/FFFFFF?text=Placeholder+Image';"/>
            </div>
            <div id="slogan1" class="slogan-1">Y o u , b u t v i r t u a l !</div>
            <div id="slogan2" class="slogan-2">Turn imagination into identity</div>
            <div id="dividerBottom" class="divider divider-bottom"></div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="loadingPopup" class="loading-popup-box">
        <div class="loading-text">Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§. . .</div>
    </div>

    <script type="module">
        // Firebase ÏïÑÎ∞îÌÉÄ ÏÉùÏÑ± Î°úÏßÅ import
        import { generateAvatarImage, downloadAvatarImage, getCurrentUserInfo } from './avatar-logic.js';

        const chatHistory = document.getElementById('chatHistory');
        const inputField = document.getElementById('inputField');
        const modalOverlay = document.getElementById('modalOverlay');
        const loadingPopup = document.getElementById('loadingPopup');
        const sidebarContainer = document.getElementById('sidebarContainer');
        let isSidebarOpen = false;

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú (HTML onclickÏóêÏÑú ÏÇ¨Ïö©)
        window.toggleSidebar = toggleSidebar;
        window.sendMessage = sendMessage;
        window.downloadImage = downloadImage;

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) sidebarContainer.classList.add('sidebar-open');
            else sidebarContainer.classList.remove('sidebar-open');
        }

        function initializeChat() {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌôïÏù∏
            const userInfo = getCurrentUserInfo();
            let greeting = "ÏïàÎÖïÌïòÏÑ∏Ïöî!";
            if (userInfo) {
                greeting = `ÏïàÎÖïÌïòÏÑ∏Ïöî, ${userInfo.displayName}Îãò!`;
            }

            const firstMessage = greeting + " ÏõêÌïòÏãúÎäî ÏïÑÎ∞îÌÉÄ Ïù¥ÎØ∏ÏßÄÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!";
            const secondMessage = "ex) Í∑ÄÏó¨Ïö¥ ÎäêÎÇåÏùò ÏïÑÏù¥Îèå ÏÜåÎÖÄ, Í∏àÎ∞ú Í∏¥ Ïõ®Ïù¥Î∏å, ÌÅ¨Í≥† Î∞òÏßùÏù¥Îäî Î∂ÑÌôçÏÉâ ÎààÎèôÏûê, Î∞ùÏùÄ ÌîºÎ∂ÄÌÜ§, Î∂ÑÌôçÏÉâÍ≥º Ìù∞ÏÉâÏùò Í∑ÄÏó¨Ïö¥ ÏùòÏÉÅ, ÏïÑÏù¥Îèå Ïï†ÎãàÎ©îÏù¥ÏÖò Ïä§ÌÉÄÏùº";
            
            setTimeout(() => {
                addMessage(firstMessage, 'system');
                setTimeout(() => { addMessage(secondMessage, 'system'); }, 1500);
            }, 1000);
        }

        function addMessage(text, senderClass) {
            if (!text || !text.trim()) return;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', senderClass);
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function sendMessage() {
            const messageText = inputField.value;
            
            if (!messageText.trim()) {
                addMessage(getStatusMessage('empty'), 'system');
                return;
            }

            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
            addMessage(messageText, 'user');
            inputField.value = '';

            // Î°úÎî© UI ÌëúÏãú
            setTimeout(() => {
                modalOverlay.style.display = 'block';
                loadingPopup.style.display = 'flex';
                loadingPopup.style.opacity = '1';
            }, 500);

            try {
                // Ïã§Ï†ú Firebase Functions Ìò∏Ï∂ú
                console.log('üé® ÏïÑÎ∞îÌÉÄ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏöîÏ≤≠:', messageText);
                const success = await generateAvatarImage(messageText);

                // Î°úÎî© UI Ïà®Í∏∞Í∏∞
                loadingPopup.style.opacity = '0';
                setTimeout(() => {
                    modalOverlay.style.display = 'none';
                    loadingPopup.style.display = 'none';
                }, 300);

                // Í≤∞Í≥º Î©îÏãúÏßÄ ÌëúÏãú
                setTimeout(() => {
                    if (success) {
                        addMessage('‚úÖ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'system');
                        addMessage('üí° ÏïÑÎûò "Îã§Ïö¥Î°úÎìú" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄÎ•º Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî!', 'system');
                    } else {
                        addMessage('‚ùå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'system');
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå ÏïÑÎ∞îÌÉÄ ÏÉùÏÑ± Ïò§Î•ò:', error);
                
                // Î°úÎî© UI Ïà®Í∏∞Í∏∞
                loadingPopup.style.opacity = '0';
                setTimeout(() => {
                    modalOverlay.style.display = 'none';
                    loadingPopup.style.display = 'none';
                }, 300);

                // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
                setTimeout(() => {
                    addMessage('‚ùå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'system');
                    addMessage(`ÏÉÅÏÑ∏: ${error.message}`, 'system');
                }, 500);
            }
        }

        // Îã§Ïö¥Î°úÎìú Ìï®Ïàò
        async function downloadImage() {
            try {
                console.log('üì• Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú ÏãúÏûë');
                addMessage('üì• Ïù¥ÎØ∏ÏßÄÎ•º Îã§Ïö¥Î°úÎìúÌï©ÎãàÎã§...', 'system');
                
                const success = await downloadAvatarImage();
                
                if (success) {
                    setTimeout(() => {
                        addMessage('‚úÖ Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'system');
                    }, 500);
                } else {
                    setTimeout(() => {
                        addMessage('‚ùå Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®. Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'system');
                    }, 500);
                }
            } catch (error) {
                console.error('‚ùå Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
                addMessage('‚ùå Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'system');
            }
        }

        // Enter ÌÇ§Î°ú Ï†ÑÏÜ°
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.addEventListener('DOMContentLoaded', () => {
            initializeChat();
        });

        // VoiceChanger & Live Ïã§Ìñâ IPC
        try {
            const { ipcRenderer } = require('electron');
            const vbtn = document.getElementById('menuVoiceChanger');
            if (vbtn) {
                vbtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ipcRenderer.send('start-voice-changer');
                });
            }
            
            const livebtn = document.getElementById('menuLive');
            if (livebtn) {
                livebtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ipcRenderer.send('start-vtuber-live');
                });
            }
        } catch (_) {
            console.log('Electron IPC not available (browser mode)');
        }

        console.log('‚úÖ Avatar page initialized');
    </script>
</body>
</html>



